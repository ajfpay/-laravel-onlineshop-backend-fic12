version: "3.8"

services:
  nginx:
    image: ${COMPOSE_PROJECT_NAME}-nginx:latest
    build:
      context: ./docker/
      args:
        BUILD_ARGUMENT_ENV: dev
      dockerfile: ./nginx/Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME}-nginx
    restart: always
    ports:
      - "91:80"
      - "445:443"
    volumes:
      - ./:/var/www/html:ro,cached
    depends_on:
      - laravel

  laravel: &laravel-template
    image: ${COMPOSE_PROJECT_NAME}-laravel:latest
    build:
      context: .
      args:
        BUILD_ARGUMENT_ENV: dev
        HOST_UID: ${HOST_UID}
        HOST_GID: ${HOST_GID}
        XDEBUG_CONFIG: ${XDEBUG_CONFIG}
      dockerfile: ./Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME}-laravel
    volumes:
      - ./:/var/www/html:cached
    environment:
      - DB_CONNECTION=mysql-nginx-proxy-manager
      - DB_HOST=db-mysql
      - DB_PORT=3306
      - DB_DATABASE=laravel
      - DB_USERNAME=root
      - DB_PASSWORD=LoginMai07
    depends_on:
      - mail

  ### Cron tasks
  supervisord:
    <<: *laravel-template
    container_name: ${COMPOSE_PROJECT_NAME}-supervisord
    expose: []
    command: ["/usr/bin/supervisord"]

  mail:
    image: axllent/mailpit:latest
    container_name: ${COMPOSE_PROJECT_NAME}-mail
    restart: always
    ports:
      - "8025:8025"
      - "1025:1025"

networks:
  default:
    external: true
    name: proxy_network
